name: Minecraft autoplay CI

on:
  push:
    branches: [ feature/autocraft-combat-sprint, main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-mod:
    name: Build Fabric mod (stable)
    runs-on: ubuntu-latest
    outputs:
      jar-path: ${{ steps.find-jar.outputs.path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-cache-${{ runner.os }}-v1

      - name: Install Gradle CLI (fallback when no root gradle wrapper)
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: '9.2.1'
          arguments: -v

      - name: Build mod (MC 1.20.4)
        working-directory: examples/minecraft-bot/fabric-autoplay
        run: gradle assemble -PmcVersion=1.20.4 --no-daemon --warning-mode=none

      - name: Run Java unit tests (mod)
        working-directory: examples/minecraft-bot/fabric-autoplay
        run: gradle test -PmcVersion=1.20.4 --no-daemon --warning-mode=none

      - name: Try build for latest (best-effort)
        working-directory: examples/minecraft-bot/fabric-autoplay
        continue-on-error: true
        run: |
          set -e
          # attempt latest; don't fail the job if mappings/loom are not yet available
          gradle assemble -PmcVersion=latest --no-daemon -x test --warning-mode=none || true

      - name: Find built JAR
        id: find-jar
        run: |
          jar=$(ls examples/minecraft-bot/fabric-autoplay/build/libs/*.jar 2>/dev/null | head -n1 || true)
          if [ -n "$jar" ]; then echo "path=$jar" >> $GITHUB_OUTPUT; else echo "path=" >> $GITHUB_OUTPUT; fi

      - name: Upload mod JAR artifact
        if: steps.find-jar.outputs.path != ''
        uses: actions/upload-artifact@v4
        with:
          name: openclaw-minecraft-mod-jar
          path: ${{ steps.find-jar.outputs.path }}

  node-smoke:
    name: Mineflayer smoke + seed harness
    runs-on: ubuntu-latest
    needs: [ build-mod ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install pnpm
        run: corepack enable && corepack prepare pnpm@latest --activate

      - name: Start Paper server (1.20.4)
        uses: itzg/minecraft-server-action@v4
        with:
          version: 1.20.4
          type: paper
          EULA: 'true'
          max-players: 4

      - name: Wait for server
        run: npx wait-for-localhost --port 25565 --timeout 120000

      - name: Install Mineflayer deps
        working-directory: examples/minecraft-bot/mineflayer-lan-bot
        run: pnpm install --frozen-lockfile=false

      - name: Run seed harness (smoke)
        working-directory: examples/minecraft-bot/mineflayer-lan-bot
        env:
          HOST: 127.0.0.1
          PORT: 25565
        run: pnpm run test-seed

      - name: Run autocraft smoke (bucket)
        working-directory: examples/minecraft-bot/mineflayer-lan-bot
        env:
          HOST: 127.0.0.1
          PORT: 25565
        run: pnpm run autocraft -- bucket

      - name: Upload mineflayer logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mineflayer-logs
          path: |
            examples/minecraft-bot/mineflayer-lan-bot/*.log
            /tmp/openclaw-*

  package-and-release:
    name: Package user ZIP + attach
    runs-on: ubuntu-latest
    needs: [ build-mod, node-smoke ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create distributable ZIP
        run: |
          mkdir -p dist
          cd examples/minecraft-bot
          zip -r "$GITHUB_WORKSPACE/dist/openclaw-autoplay-$(date +%Y.%m.%d).zip" . -x "**/node_modules/**" "**/.git/**"

      - name: Upload ZIP
        uses: actions/upload-artifact@v4
        with:
          name: openclaw-autoplay-zip
          path: dist/*.zip

  ci-summary:
    name: CI summary (annotations)
    runs-on: ubuntu-latest
    needs: [ build-mod, node-smoke, package-and-release ]
    steps:
      - name: Print summary
        run: |
          echo "CI: build-mod=${{ needs.build-mod.result }}"
          echo "CI: node-smoke=${{ needs.node-smoke.result }}"
          echo "Artifacts:"
          ls -la examples/minecraft-bot/fabric-autoplay/build/libs || true
          ls -la dist || true
